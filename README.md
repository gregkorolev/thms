# thms
telemetry habitat monitoring system


Протокол обмена многофункционального автономного регистратора  МАР-1.
Параметры для работы регистратора с http-сервером.
1. Передача данных регистратора. Регистратор связывается с сервером и отсылает свои данные.
1.1. адрес сервера и url жестко прописаны в прошивке регистратора.
http://docs.esmc.info/test_upload.php
1.2. регистратора выполняет отсылку данных методом POST.
1.3. в заголовках http будет присутствовать property:
Content-Type: application/json

расшифровка ключей
sn      - серийный/заводской номер (уникальный для каждого регистратора) 1..999999
ctr     - счетчик попыток связи регистратора  с сервером - целое число 1..100
batt    - уровень заряда батареи целое число от 0 до 100 %
date    - дата GPS,  (UTC/GMT+0) формат yyyyMMdd
time    - время GPS, (UTC/GMT+0) формат hhmmss
lat     - широта  ±dd.dddddd
lon     - долгота ±dd.dddddd
gpsvis  - видимые спутники GPS  0..100
gnsvis  - видимые спутники GLONASS  0..100
satused - количество использованных спутников для геолокации 0.. 100
"gsmlocationcode" - числовой параметр - значения от 0 до 65535. значение 0 - координаты по GSM успешно получены,  другое значение - код ошибки. Параметры ниже присутствуют только если "gsmlc" равен 0 (нулю).
"gsmlat" - широта  ±dd.dddddd
"gsmlon" - долгота ±dd.dddddd
"gsmdate" - дата GSM, формат yyyyMMdd
"gsmtime" – время GSM, формат hhmmss
"humidity"  - влажность, формат 0 .. 100 %
"temperature 1"  - температура , формат ±dd.dd  -40 .. 120 град.С
"pressurebarom "  - давление воздуха, формат  300 .. 1200 hPa
"temperature 2"  - температура , формат ±dd.dd  -40 .. 85 град.С
"TVOC "  - летучие органические вещества, формат 0 .. 60000 ppb
"CO2eq"  -  углекислый газ, формат    400 .. 60000 ppm
"acoustic" – звуковое давление, формат   0 .. 120dBSPL


Формат запроса:  (в теле http запроса будет набор данных в формате json)
{
"sn":"123456",
"ctr":"1",
"batt":"87",
"date":"yyyyMMdd",
"time":"hhmmss",
"lat":"+dd.dddddd",
"lon":"+dd.dddddd",
"gpsvis":"10",
"gnsvis":"11",
"satused":"6",
"gsmlc":"gsmlocationcode",
"gsmlat":"+ddd.dddddd",
"gsmlon":"+ddd.dddddd",
"gsmdate":"yyyyMMdd",
"gsmtime":"hhmmss",
"humidity":"100",
"temperature 1":"±dd.dd",
"pressurebarom ":"1200",
"temperature 2":" ±dd.dd",
"TVOC ":"60000",
"CO2eq":"60000",
"acoustic":"120"
}

Формат ответа: (от сервера)
Сервер возвращает стандартный код протокола HTTP согласно RFC2616:
Значение	описание
HTTP/1.1 200 OK	HTTP сервер успешно принял данные и записал в базу данных
HTTP/1.1 400 Bad Request	HTTP сервер не принял данные (например, формат данных не соответствует спецификации)
HTTP/1.1 401 Unauthorized	серийный/заводской номер из запроса отсутствует в БД (маяк с таким номером ещё не был выпущен)
HTTP/1.1 500 Internal Server Error	HTTP сервер принял данные, но не смог записать в БД (например, БД не отвечает)
HTTP/1.1 503 Service Unavailable	HTTP сервер недоступен

2. Обновления настроек регистратора с сервера – регистратор периодически посылает запрос методом GET с заранее известным url.
Формат запроса:  (от регистратора  серверу)
http://docs.esmc.info/test_settings.php?ver=1&sn=XXXXXX
где параметры в url
name	Значение	описание
ver	1	Версия ПО регистратора. Формат ответа зависит от номера версии. Ответ сервера должен соответствовать версии, которую прислал регистратор. Это сделано для обеспечения обратной совместимости, на случай, если ПО регистратора будет меняться.
sn	1..999999	серийный/заводской номер (уникальный для каждого регистратора)

Тело запроса - пустое


Формат ответа: (от сервера)
Сервер возвращает стандартный код протокола HTTP согласно RFC2616:
Значение	описание
HTTP/1.1 200 OK	HTTP сервер успешно принял данные и записал в базу данных
HTTP/1.1 400 Bad Request	HTTP сервер не принял данные (например, формат данных не соответствует спецификации)
HTTP/1.1 401 Unauthorized	серийный/заводской номер из запроса отсутствует в БД (регистратора с таким номером ещё не был выпущен)
HTTP/1.1 500 Internal Server Error	HTTP сервер принял данные, но не смог записать в БД (например, БД не отвечает)
HTTP/1.1 503 Service Unavailable	HTTP сервер недоступен

Тело ответа (стандартный json с параметрами)
{
"sn":"123456",
"ctr":"1",
"cfgLock":"1",
"updateTimeMin":"240",
"smsEnable":"1",
"phoneNumber":"+7XXXXXXXXXX",
"paramsmsEnable": "1110000000011111100000"
}

расшифровка ключей (для версии «1»)
sn	серийный/заводской номер (уникальный для каждого регистратора) 1..999999
ctr	счетчик попыток связи регистратора с сервером - целое число 1..100
cfgLock	конфигурация регистратора закрыта для изменений  0- нет, 1 - да
updateTimeMin	период в мин., с которым регистратор отсылает на сервер свои данные 1..1440
smsEnable	разрешение отправки СМС 0 - нет, 1 - да
phoneNumber	номер телефона для отправки СМС +7XXXXXXXXXX
paramsmsEnable	1-	виден, 0 – не виден (в сообщении смс)  

запрос на изменение параметров сразу после отсылки данных регистратором в той же gprs сессии для экономии энергии и трафика.


Формат СМС посылки.

В тексте смс в цифровом виде через запятую записаны следующие данные:
"sn","ctr","batt","date","time","lat","lon","gpsvis","gnsvis","satused","gsmlc","gsmlat","gsmlon",
"gsmdate","gsmtime" , "humidity",  "temperature 1" , "pressurebarom " , "temperature 2" , "TVOC' , "CO2eq", "acoustic".

Видимость данных в смс сообщении выбирается в  paramsmsEnable.




